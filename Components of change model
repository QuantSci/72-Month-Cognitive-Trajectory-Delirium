componentsofchange_mpluscode <- mplusObject(
  MODEL = " 
i s | y0 y1 y2 y6 y12 y18 y24 y30 y36 AT t0 t1 t2 t6 t12 t18 t24 t30 t36;
i s | y48 y60 y72 AT  t48 t60 t72;
p  BY  y0@0 y1@1 y2@1 y6@1 y12@1 y18@1 y24@1 y30@1 y36@1 y48@1 y60@1 y72@1;
r  BY  y0@0 y1@0 y2@1 y6@1 y12@1 y18@1 y24@1 y30@1 y36@1 y48@1 y60@1 y72@1;
lr BY  y0@0 y1@0 y2@0 y6@.2 y12@.507 y18@.79 y24@.963 y30@1 y36@1 y48@1 y60@1 y72@1;
 [i*] (i);
 [s*] (s);  
 [p*] (p);
 [r*] (r);
 [lr*] (lr);
 
 p@0;
 r@0;
 lr*;
 i*;
 s*;
 
 s with i;
 
 i with p@0;
 i with r@0;
 i with lr@0;
 
 s with p@0;
 s with r@0;
 s with lr;
 
 r with p@0;
 
 lr with p@0 ;
 lr with r@0 ;
 
 s ON delyes (del_s);
 s ON cage crace cfem ciqc ciadl cgds ccci;
 p ON delyes (del_p);
 p ON cage crace cfem ciqc ciadl cgds ccci;
 r ON delyes (del_r);
 r ON cage crace cfem ciqc ciadl cgds ccci;
 lr ON delyes (del_lr);
 lr ON cage crace cfem ciqc ciadl cgds ccci;
 i ON delyes (del_i); 
 
 i ON cage crace cfem ciqc ciadl cgds ccci; 
 !delyes ON i;
 
 !delyes ON cage crace cfem ciqc ciadl cgds ccci; 
  ",
MODELCONSTRAINT = "new(y0_nd, y1_nd, y2_nd, y6_nd, y12_nd, y18_nd,
                      y24_nd, y30_nd, y36_nd, y48_nd, y60_nd, y72_nd,
                      y0_d, y1_d, y2_d, y6_d, y12_d, y18_d,
                      y24_d, y30_d, y36_d, y48_d, y60_d, y72_d,
                      y0_diff, y1_diff, y2_diff, y6_diff, y12_diff,
                      y18_diff, y24_diff, y30_diff, y36_diff,
                      y48_diff, y60_diff, y72_diff,
                      y1_d_bd, y2_d_bd, y6_d_bd, y12_d_bd,
                      y18_d_bd, y24_d_bd, y30_d_bd, y36_d_bd,
                      y48_d_bd, y60_d_bd, y72_d_bd,
                      y1_nd_bd, y2_nd_bd, y6_nd_bd, y12_nd_bd,
                      y18_nd_bd, y24_nd_bd, y30_nd_bd, y36_nd_bd,
                      y48_nd_bd, y60_nd_bd, y72_nd_bd,
                      y1_bl_diff, y2_bl_diff, y6_bl_diff, y12_bl_diff,
                      y18_bl_diff, y24_bl_diff, y30_bl_diff, y36_bl_diff,
                      y48_bl_diff, y60_bl_diff, y72_bl_diff,);
y0_nd = i*1 + s*0   + p*0 + r*0 + lr*0;
y1_nd = i*1 + s*.083  + p*1 + r*0 + lr*0;
y2_nd = i*1 + s*.167 + p*1 + r*1 + lr*0;
y6_nd = i*1 + s*.5  + p*1 + r*1 + lr*.2;
y12_nd = i*1 + s*1   + p*1 + r*1 + lr*.507;
y18_nd = i*1 + s*1.5 + p*1 + r*1 + lr*.79;
y24_nd = i*1 + s*2   + p*1 + r*1 + lr*.963;
y30_nd = i*1 + s*2.5 + p*1 + r*1 + lr*1;
y36_nd = i*1 + s*3   + p*1 + r*1 + lr*1;
y48_nd = i*1 + s*4   + p*1 + r*1 + lr*1;
y60_nd = i*1 + s*5   + p*1 + r*1 + lr*1;
y72_nd = i*1 + s*6   + p*1 + r*1 + lr*1;
y0_d  = (i+del_i)*1+(s+del_s)*0 +(p+del_p)*0+(r+del_r)*0+(lr+del_lr)*0;
y1_d  = (i+del_i)*1+(s+del_s)*.083+(p+del_p)*1+(r+del_r)*0+(lr+del_lr)*0;
y2_d  = (i+del_i)*1+(s+del_s)*.167+(p+del_p)*1+(r+del_r)*1+(lr+del_lr)*0;
y6_d  = (i+del_i)*1+(s+del_s)*.5+(p+del_p)*1+(r+del_r)*1+(lr+del_lr)*.2;
y12_d = (i+del_i)*1+(s+del_s)*1 +(p+del_p)*1+(r+del_r)*1+(lr+del_lr)*.507;
y18_d = (i+del_i)*1+(s+del_s)*1.5+(p+del_p)*1+(r+del_r)*1+(lr+del_lr)*.79;
y24_d = (i+del_i)*1+(s+del_s)*2 +(p+del_p)*1+(r+del_r)*1+(lr+del_lr)*.963;
y30_d = (i+del_i)*1+(s+del_s)*2.5+(p+del_p)*1+(r+del_r)*1+(lr+del_lr)*1;
y36_d = (i+del_i)*1+(s+del_s)*3 +(p+del_p)*1+(r+del_r)*1+(lr+del_lr)*1;
y48_d = (i+del_i)*1+(s+del_s)*4 +(p+del_p)*1+(r+del_r)*1+(lr+del_lr)*1;
y60_d = (i+del_i)*1+(s+del_s)*5 +(p+del_p)*1+(r+del_r)*1+(lr+del_lr)*1;
y72_d = (i+del_i)*1+(s+del_s)*6 +(p+del_p)*1+(r+del_r)*1+(lr+del_lr)*1;
y0_diff = y0_d - y0_nd;
y1_diff = y1_d - y1_nd;
y2_diff = y2_d - y2_nd;
y6_diff = y6_d - y6_nd;
y12_diff = y12_d - y12_nd;
y18_diff = y18_d - y18_nd;
y24_diff = y24_d - y24_nd;
y30_diff = y30_d - y30_nd;
y36_diff = y36_d - y36_nd;
y48_diff = y48_d - y48_nd;
y60_diff = y60_d - y60_nd;
y72_diff = y72_d - y72_nd;
y1_d_bd = y1_d - y0_d;
y2_d_bd = y2_d - y0_d;
y6_d_bd = y6_d - y0_d;
y12_d_bd = y12_d - y0_d;
y18_d_bd = y18_d - y0_d;
y24_d_bd = y24_d - y0_d;
y30_d_bd = y30_d - y0_d;
y36_d_bd = y36_d - y0_d;
y48_d_bd = y48_d - y0_d;
y60_d_bd = y60_d - y0_d;
y72_d_bd = y72_d - y0_d;
y1_nd_bd = y1_nd - y0_nd;
y2_nd_bd = y2_nd - y0_nd;
y6_nd_bd = y6_nd - y0_nd;
y12_nd_bd = y12_nd - y0_nd;
y18_nd_bd = y18_nd - y0_nd;
y24_nd_bd = y24_nd - y0_nd;
y30_nd_bd = y30_nd - y0_nd;
y36_nd_bd = y36_nd - y0_nd;
y48_nd_bd = y48_nd - y0_nd;
y60_nd_bd = y60_nd - y0_nd;
y72_nd_bd = y72_nd - y0_nd;
y1_bl_diff = y1_d_bd - y1_nd_bd;
y2_bl_diff = y2_d_bd - y2_nd_bd;
y6_bl_diff = y6_d_bd - y6_nd_bd;
y12_bl_diff = y12_d_bd - y12_nd_bd;
y18_bl_diff = y18_d_bd - y18_nd_bd;
y24_bl_diff = y24_d_bd - y24_nd_bd;
y30_bl_diff = y30_d_bd - y30_nd_bd;
y36_bl_diff = y36_d_bd - y36_nd_bd;
y48_bl_diff = y48_d_bd - y48_nd_bd;
y60_bl_diff = y60_d_bd - y60_nd_bd;
y72_bl_diff = y72_d_bd - y72_nd_bd;
",

# MODELTEST = "
# 0 = y0_nd - y0_d;
# !0 = y1_nd - y1_d;
# !0 = y2_nd - y2_d;
# !0 = y6_nd - y6_d;
# !0 = y12_nd - y12_d;
# !0 = y18_nd - y18_d;
# !0 = y24_nd - y24_d;
# !0 = y30_nd - y30_d;
# !0 = y36_nd - y36_d;
# !0 = y48_nd - y48_d;
# !0 = y60_nd - y60_d;
# !0 = y72_nd - y72_d;
# ",
  usevariables = colnames(analysis_data),
  VARIABLE = "idvariable = mplusid;
tscores = t0 t1 t2 t6 t12 t18 t24 t30 t36 t48 t60 t72;
!CATEGORICAL ARE delyes;",
#  OUTPUT = "TECH4;",
  ANALYSIS = "ESTIMATOR = MLR;
TYPE = RANDOM;",
  rdata = analysis_data,
  SAVEDATA = "FILE IS componentsofchange.dat;
SAVE is fscores;
FORMAT IS free;"
)

componentsofchange_output <- mplusModeler(componentsofchange_mpluscode, modelout = "componentsofchange_output_covariates.inp", run = TRUE)
